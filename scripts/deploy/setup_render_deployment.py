#!/usr/bin/env python3
"""
Script de Automa√ß√£o para Deploy no Render

Este script automatiza a configura√ß√£o de secrets e fornece instru√ß√µes
para criar um Blueprint no Render para o projeto TechZe Diagnostico.

Autor: Gemini AI Assistant
Data: 2024
"""

import os
import json
import requests
from typing import Dict, List, Optional
from dataclasses import dataclass
from datetime import datetime


@dataclass
class RenderSecret:
    """Representa um secret do Render."""
    key: str
    description: str
    required: bool = True
    example: str = ""


class RenderDeploymentAutomator:
    """Automatiza a configura√ß√£o de deployment no Render."""
    
    def __init__(self):
        self.secrets = self._define_required_secrets()
        self.render_api_key = os.getenv('RENDER_API_KEY')
        self.github_repo = "https://github.com/seu-usuario/TechZe-Diagnostico"
        
    def _define_required_secrets(self) -> List[RenderSecret]:
        """Define todos os secrets necess√°rios para o projeto."""
        return [
            RenderSecret(
                key="SUPABASE_URL",
                description="URL do projeto Supabase",
                example="https://seu-projeto.supabase.co"
            ),
            RenderSecret(
                key="SUPABASE_ANON_KEY",
                description="Chave an√¥nima do Supabase (p√∫blica)",
                example="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            ),
            RenderSecret(
                key="SUPABASE_SERVICE_ROLE_KEY",
                description="Chave de service role do Supabase (privada)",
                example="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            ),
            RenderSecret(
                key="JWT_SECRET_KEY",
                description="Chave secreta para assinatura de tokens JWT",
                example="sua-chave-secreta-super-segura-aqui"
            ),
            RenderSecret(
                key="REDIS_URL",
                description="URL de conex√£o com Redis (opcional para cache)",
                required=False,
                example="redis://localhost:6379"
            ),
            RenderSecret(
                key="SENTRY_DSN",
                description="DSN do Sentry para monitoramento de erros",
                required=False,
                example="https://chave@sentry.io/projeto"
            )
        ]
    
    def generate_secrets_checklist(self) -> str:
        """Gera uma checklist dos secrets necess√°rios."""
        checklist = []
        checklist.append("# üîê CHECKLIST DE SECRETS PARA RENDER")
        checklist.append("")
        checklist.append("## Secrets Obrigat√≥rios")
        checklist.append("")
        
        for secret in self.secrets:
            if secret.required:
                status = "[ ]"  # Checkbox vazio
                checklist.append(f"{status} **{secret.key}**")
                checklist.append(f"   - Descri√ß√£o: {secret.description}")
                if secret.example:
                    checklist.append(f"   - Exemplo: `{secret.example}`")
                checklist.append("")
        
        checklist.append("## Secrets Opcionais")
        checklist.append("")
        
        for secret in self.secrets:
            if not secret.required:
                status = "[ ]"  # Checkbox vazio
                checklist.append(f"{status} **{secret.key}**")
                checklist.append(f"   - Descri√ß√£o: {secret.description}")
                if secret.example:
                    checklist.append(f"   - Exemplo: `{secret.example}`")
                checklist.append("")
        
        return "\n".join(checklist)
    
    def generate_render_instructions(self) -> str:
        """Gera instru√ß√µes detalhadas para configura√ß√£o no Render."""
        instructions = []
        instructions.append("# üöÄ GUIA COMPLETO DE DEPLOY NO RENDER")
        instructions.append("")
        instructions.append("## Fase 1: Configura√ß√£o de Secrets (30 minutos)")
        instructions.append("")
        instructions.append("### Passo 1: Acesse o Dashboard do Render")
        instructions.append("1. Acesse https://dashboard.render.com")
        instructions.append("2. Fa√ßa login na sua conta")
        instructions.append("3. No menu lateral, clique em **Environment Groups**")
        instructions.append("4. Clique em **New Environment Group**")
        instructions.append("5. Nomeie como: `techze-diagnostico-secrets`")
        instructions.append("")
        instructions.append("### Passo 2: Adicione os Secrets")
        instructions.append("")
        
        for i, secret in enumerate(self.secrets, 1):
            required_text = "(OBRIGAT√ìRIO)" if secret.required else "(OPCIONAL)"
            instructions.append(f"**{i}. {secret.key}** {required_text}")
            instructions.append(f"- Clique em **Add Environment Variable**")
            instructions.append(f"- Key: `{secret.key}`")
            instructions.append(f"- Value: [Insira o valor real aqui]")
            instructions.append(f"- Descri√ß√£o: {secret.description}")
            if secret.example:
                instructions.append(f"- Formato esperado: `{secret.example}`")
            instructions.append("")
        
        instructions.append("## Fase 2: Cria√ß√£o do Blueprint (15 minutos)")
        instructions.append("")
        instructions.append("### Passo 1: Criar Blueprint")
        instructions.append("1. No dashboard do Render, clique em **Blueprints**")
        instructions.append("2. Clique em **New Blueprint**")
        instructions.append("3. Conecte ao seu reposit√≥rio GitHub")
        instructions.append("4. Selecione o reposit√≥rio: `TechZe-Diagnostico`")
        instructions.append("5. Branch: `main`")
        instructions.append("6. Blueprint file: `render.yaml` (j√° configurado)")
        instructions.append("")
        instructions.append("### Passo 2: Configurar Environment Group")
        instructions.append("1. Na se√ß√£o **Environment Groups**, selecione: `techze-diagnostico-secrets`")
        instructions.append("2. Clique em **Create Blueprint**")
        instructions.append("")
        instructions.append("### Passo 3: Deploy Autom√°tico")
        instructions.append("1. O Render ir√° automaticamente:")
        instructions.append("   - Criar o servi√ßo de API (techze-diagnostico-api)")
        instructions.append("   - Criar o servi√ßo de Frontend (techze-diagnostico-frontend)")
        instructions.append("   - Configurar as vari√°veis de ambiente")
        instructions.append("   - Iniciar o primeiro deploy")
        instructions.append("")
        instructions.append("## Fase 3: Verifica√ß√£o (10 minutos)")
        instructions.append("")
        instructions.append("### URLs de Acesso")
        instructions.append("- **API**: https://techze-diagnostico-api.onrender.com")
        instructions.append("- **Frontend**: https://techze-diagnostico-frontend.onrender.com")
        instructions.append("- **Health Check**: https://techze-diagnostico-api.onrender.com/health")
        instructions.append("")
        instructions.append("### Verifica√ß√µes")
        instructions.append("- [ ] API responde no endpoint /health")
        instructions.append("- [ ] Frontend carrega corretamente")
        instructions.append("- [ ] Logs n√£o mostram erros cr√≠ticos")
        instructions.append("- [ ] Conex√£o com Supabase funcionando")
        instructions.append("")
        
        return "\n".join(instructions)
    
    def create_env_template(self) -> str:
        """Cria um template de arquivo .env para refer√™ncia."""
        template = []
        template.append("# Template de Vari√°veis de Ambiente para Render")
        template.append(f"# Gerado em: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        template.append("")
        template.append("# IMPORTANTE: N√£o commite este arquivo com valores reais!")
        template.append("# Use este template apenas como refer√™ncia.")
        template.append("")
        
        for secret in self.secrets:
            required_comment = "# OBRIGAT√ìRIO" if secret.required else "# OPCIONAL"
            template.append(f"# {secret.description} {required_comment}")
            template.append(f"{secret.key}={secret.example}")
            template.append("")
        
        return "\n".join(template)
    
    def validate_current_env(self) -> Dict[str, bool]:
        """Valida se as vari√°veis de ambiente atuais est√£o configuradas."""
        validation = {}
        
        for secret in self.secrets:
            value = os.getenv(secret.key)
            validation[secret.key] = {
                'configured': value is not None and value.strip() != '',
                'required': secret.required,
                'value_preview': value[:20] + '...' if value and len(value) > 20 else value
            }
        
        return validation
    
    def generate_validation_report(self) -> str:
        """Gera um relat√≥rio de valida√ß√£o das vari√°veis atuais."""
        validation = self.validate_current_env()
        report = []
        
        report.append("# üìä RELAT√ìRIO DE VALIDA√á√ÉO DE VARI√ÅVEIS")
        report.append("")
        report.append("## Status Atual das Vari√°veis de Ambiente")
        report.append("")
        
        for key, status in validation.items():
            icon = "‚úÖ" if status['configured'] else "‚ùå"
            required_text = "(OBRIGAT√ìRIO)" if status['required'] else "(OPCIONAL)"
            
            report.append(f"{icon} **{key}** {required_text}")
            
            if status['configured']:
                report.append(f"   - Status: Configurado")
                if status['value_preview']:
                    report.append(f"   - Preview: `{status['value_preview']}`")
            else:
                report.append(f"   - Status: N√ÉO CONFIGURADO")
                if status['required']:
                    report.append(f"   - ‚ö†Ô∏è A√á√ÉO NECESS√ÅRIA: Esta vari√°vel √© obrigat√≥ria")
            
            report.append("")
        
        # Resumo
        total_vars = len(validation)
        configured_vars = sum(1 for v in validation.values() if v['configured'])
        required_vars = sum(1 for v in validation.values() if v['required'])
        configured_required = sum(1 for v in validation.values() if v['required'] and v['configured'])
        
        report.append("## üìà Resumo")
        report.append("")
        report.append(f"- Total de vari√°veis: {total_vars}")
        report.append(f"- Configuradas: {configured_vars}/{total_vars}")
        report.append(f"- Obrigat√≥rias configuradas: {configured_required}/{required_vars}")
        
        if configured_required == required_vars:
            report.append("- ‚úÖ **Todas as vari√°veis obrigat√≥rias est√£o configuradas!**")
        else:
            missing = required_vars - configured_required
            report.append(f"- ‚ùå **{missing} vari√°veis obrigat√≥rias precisam ser configuradas**")
        
        return "\n".join(report)
    
    def run_automation(self) -> None:
        """Executa o processo completo de automa√ß√£o."""
        print("üöÄ Iniciando automa√ß√£o de deploy no Render...")
        print()
        
        # Criar diret√≥rio de output
        output_dir = "render_deployment_guide"
        os.makedirs(output_dir, exist_ok=True)
        
        # Gerar arquivos
        files_to_create = {
            "secrets_checklist.md": self.generate_secrets_checklist(),
            "deployment_instructions.md": self.generate_render_instructions(),
            "env_template.txt": self.create_env_template(),
            "validation_report.md": self.generate_validation_report()
        }
        
        for filename, content in files_to_create.items():
            filepath = os.path.join(output_dir, filename)
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"‚úÖ Criado: {filepath}")
        
        print()
        print("üìÅ Arquivos gerados na pasta: render_deployment_guide/")
        print()
        print("üìã PR√ìXIMOS PASSOS:")
        print("1. Abra o arquivo 'deployment_instructions.md' para instru√ß√µes completas")
        print("2. Use 'secrets_checklist.md' para verificar todos os secrets necess√°rios")
        print("3. Consulte 'validation_report.md' para status atual das vari√°veis")
        print("4. Use 'env_template.txt' como refer√™ncia para configura√ß√£o")
        print()
        print("üéØ A√á√ÉO IMEDIATA: Configure os secrets no Render Dashboard primeiro!")


def main():
    """Fun√ß√£o principal."""
    automator = RenderDeploymentAutomator()
    automator.run_automation()


if __name__ == "__main__":
    main()