import{j as e}from"../vendor/vendor-query.CYtcMPNU.js";import{a}from"../vendor/vendor-react.C0-ekqbG.js";import{k as s,i as r,v as t,u as o,o as i,j as n,p as c,a as l,b as d,e as m,f as x,c as h,d as u,g as p,D as j,m as v,r as g}from"../entry/index.BTJ1QXK9.js";import{B as f}from"./badge.BCKbA_Tg.js";import{R as w,I as y}from"../vendor/vendor-ui.TbV-WW-S.js";import{t as N}from"./use-toast.DAVCncE5.js";import{T as b,a as _,b as E,c as S}from"./tabs.BJawdkgg.js";import{P as O}from"./phone.D-Ty1FlK.js";import{S as q}from"./star.BtdBosQj.js";import{F as D}from"./file-text.LuSAC_HD.js";import"../vendor/vendor-supabase.CnuDrxPg.js";import"../vendor/vendor-utils.Cp7Vw4Xn.js";const C=s("history",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]),z=s("message-square",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]),k=a.forwardRef((({className:a,value:s,...t},o)=>e.jsx(w,{ref:o,className:r("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...t,children:e.jsx(y,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(s||0)}%)`}})})));k.displayName=w.displayName;const $=new class{async obterOrdensAtivas(e){try{const{data:a,error:s}=await t.from("ordens_servico").select("\n          *,\n          cliente:clientes(*),\n          equipamento:equipamentos(*),\n          tecnico:tecnicos(*),\n          orcamento:orcamentos(*),\n          diagnostico:diagnosticos(*)\n        ").eq("cliente_id",e).neq("status","concluido").order("criado_em",{ascending:!1});if(s)throw new Error(`Erro ao buscar ordens ativas: ${s.message}`);return a||[]}catch(a){throw a}}async obterHistorico(e){try{const{data:a,error:s}=await t.from("ordens_servico").select("\n          *,\n          cliente:clientes(*),\n          equipamento:equipamentos(*),\n          tecnico:tecnicos(*),\n          orcamento:orcamentos(*),\n          diagnostico:diagnosticos(*),\n          avaliacao:avaliacoes(*)\n        ").eq("cliente_id",e).eq("status","concluido").order("atualizado_em",{ascending:!1}).limit(50);if(s)throw new Error(`Erro ao buscar histórico: ${s.message}`);return a||[]}catch(a){throw a}}async obterDetalhesOS(e){try{const{data:a,error:s}=await t.from("ordens_servico").select("\n          *,\n          cliente:clientes(*),\n          equipamento:equipamentos(*),\n          tecnico:tecnicos(*),\n          orcamento:orcamentos(*),\n          diagnostico:diagnosticos(*),\n          avaliacao:avaliacoes(*),\n          observacoes:observacoes_os(*)\n        ").eq("id",e).single();if(s)throw new Error(`Erro ao buscar detalhes da OS: ${s.message}`);if(!a)throw new Error("Ordem de serviço não encontrada");return a}catch(a){throw a}}async avaliarServico(e,a){try{const{data:s}=await t.from("avaliacoes").select("id").eq("ordem_servico_id",e).single();if(s)throw new Error("Esta ordem de serviço já foi avaliada");const{error:r}=await t.from("avaliacoes").insert({ordem_servico_id:e,nota:a.nota,comentario:a.comentario,criado_em:(new Date).toISOString()});if(r)throw new Error(`Erro ao salvar avaliação: ${r.message}`)}catch(s){throw s}}async baixarOrcamento(e){try{const{data:a,error:s}=await t.from("orcamentos").select("\n          *,\n          ordem_servico:ordens_servico(\n            *,\n            cliente:clientes(*),\n            equipamento:equipamentos(*)\n          ),\n          itens:orcamento_itens(*)\n        ").eq("id",e).single();if(s)throw new Error(`Erro ao buscar orçamento: ${s.message}`);if(!a)throw new Error("Orçamento não encontrado");const r=await fetch("/api/orcamentos/pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orcamento:a})});if(!r.ok)throw new Error("Erro ao gerar PDF do orçamento");return await r.blob()}catch(a){throw a}}async aprovarOrcamento(e){try{const{error:a}=await t.from("orcamentos").update({status:"aprovado",aprovado_em:(new Date).toISOString(),atualizado_em:(new Date).toISOString()}).eq("id",e);if(a)throw new Error(`Erro ao aprovar orçamento: ${a.message}`);const{data:s}=await t.from("orcamentos").select("ordem_servico_id").eq("id",e).single();s?.ordem_servico_id&&await t.from("ordens_servico").update({status:"em_reparo",atualizado_em:(new Date).toISOString()}).eq("id",s.ordem_servico_id)}catch(a){throw a}}async rejeitarOrcamento(e,a){try{const{error:s}=await t.from("orcamentos").update({status:"rejeitado",motivo_rejeicao:a,rejeitado_em:(new Date).toISOString(),atualizado_em:(new Date).toISOString()}).eq("id",e);if(s)throw new Error(`Erro ao rejeitar orçamento: ${s.message}`);const{data:r}=await t.from("orcamentos").select("ordem_servico_id").eq("id",e).single();r?.ordem_servico_id&&await t.from("observacoes_os").insert({ordem_servico_id:r.ordem_servico_id,tipo:"sistema",descricao:"Orçamento rejeitado pelo cliente"+(a?`: ${a}`:""),criado_em:(new Date).toISOString()})}catch(s){throw s}}async enviarMensagem(e,a){try{const{error:s}=await t.from("mensagens_os").insert({ordem_servico_id:e,remetente_tipo:"cliente",mensagem:a,criado_em:(new Date).toISOString()});if(s)throw new Error(`Erro ao enviar mensagem: ${s.message}`)}catch(s){throw s}}async obterMensagens(e){try{const{data:a,error:s}=await t.from("mensagens_os").select("*").eq("ordem_servico_id",e).order("criado_em",{ascending:!0});if(s)throw new Error(`Erro ao buscar mensagens: ${s.message}`);return a||[]}catch(a){throw a}}async atualizarPerfil(e,a){try{const{error:s}=await t.from("clientes").update({...a,atualizado_em:(new Date).toISOString()}).eq("id",e);if(s)throw new Error(`Erro ao atualizar perfil: ${s.message}`)}catch(s){throw s}}};const I={aguardando_diagnostico:{label:"Aguardando Diagnóstico",color:"bg-blue-100 text-blue-800",progress:20,icon:e.jsx(g,{className:"w-4 h-4"})},diagnostico_concluido:{label:"Diagnóstico Concluído",color:"bg-yellow-100 text-yellow-800",progress:40,icon:e.jsx(D,{className:"w-4 h-4"})},aguardando_aprovacao:{label:"Aguardando Aprovação",color:"bg-orange-100 text-orange-800",progress:50,icon:e.jsx(n,{className:"w-4 h-4"})},em_reparo:{label:"Em Reparo",color:"bg-purple-100 text-purple-800",progress:75,icon:e.jsx(g,{className:"w-4 h-4"})},concluido:{label:"Concluído",color:"bg-green-100 text-green-800",progress:100,icon:e.jsx(x,{className:"w-4 h-4"})}},A=()=>{const{user:s}=o(),{ordensServico:r,loading:t,error:g,carregarDados:w,avaliarServico:y,baixarOrcamento:D}=function(e={}){const{autoLoad:s=!0}=e,{user:r}=o(),[t,i]=a.useState([]),[n,c]=a.useState([]),[l,d]=a.useState(!1),[m,x]=a.useState(null);return{ordensServico:t,historico:n,loading:l,error:m,carregarDados:a.useCallback((async()=>{if(r?.id)try{d(!0),x(null);const[e,a]=await Promise.all([$.obterOrdensAtivas(r.id),$.obterHistorico(r.id)]);i(e),c(a)}catch(e){const a=e instanceof Error?e.message:"Erro ao carregar dados";x(a),N({title:"Erro",description:a,variant:"destructive"})}finally{d(!1)}else x("Usuário não autenticado")}),[r?.id]),avaliarServico:a.useCallback((async(e,a)=>{try{await $.avaliarServico(e,a),c((s=>s.map((s=>s.id===e?{...s,avaliacao:{...a,criadaEm:new Date}}:s)))),N({title:"Sucesso",description:"Avaliação enviada com sucesso!"})}catch(s){const e=s instanceof Error?s.message:"Erro ao enviar avaliação";N({title:"Erro",description:e,variant:"destructive"})}}),[]),baixarOrcamento:a.useCallback((async e=>{try{const a=await $.baixarOrcamento(e),s=window.URL.createObjectURL(a),r=document.createElement("a");r.href=s,r.download=`orcamento-${e}.pdf`,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(s),N({title:"Sucesso",description:"Orçamento baixado com sucesso!"})}catch(a){const e=a instanceof Error?a.message:"Erro ao baixar orçamento";N({title:"Erro",description:e,variant:"destructive"})}}),[]),aprovarOrcamento:a.useCallback((async e=>{try{await $.aprovarOrcamento(e),i((a=>a.map((a=>a.orcamento?.id===e?{...a,orcamento:{...a.orcamento,status:"aprovado"},status:"em_reparo"}:a)))),N({title:"Sucesso",description:"Orçamento aprovado! O reparo será iniciado em breve."})}catch(a){const e=a instanceof Error?a.message:"Erro ao aprovar orçamento";N({title:"Erro",description:e,variant:"destructive"})}}),[]),rejeitarOrcamento:a.useCallback((async(e,a)=>{try{await $.rejeitarOrcamento(e,a),i((a=>a.map((a=>a.orcamento?.id===e?{...a,orcamento:{...a.orcamento,status:"rejeitado"}}:a)))),N({title:"Orçamento rejeitado",description:"O orçamento foi rejeitado. Entraremos em contato para discutir alternativas."})}catch(s){const e=s instanceof Error?s.message:"Erro ao rejeitar orçamento";N({title:"Erro",description:e,variant:"destructive"})}}),[]),acompanharOS:a.useCallback((async e=>{try{const a=await $.obterDetalhesOS(e);return i((s=>s.map((s=>s.id===e?a:s)))),a}catch(a){const e=a instanceof Error?a.message:"Erro ao carregar detalhes da OS";throw N({title:"Erro",description:e,variant:"destructive"}),a}}),[])}}(),[A,R]=a.useState("atual");a.useEffect((()=>{w()}),[w]);const M=r.filter((e=>"concluido"!==e.status)),P=r.filter((e=>"concluido"===e.status));return t?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando seus dados..."})]})}):g?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs(i,{className:"max-w-md",children:[e.jsx(n,{className:"h-4 w-4"}),e.jsx(c,{children:g})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white shadow-sm border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex justify-between items-center py-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900",children:["Olá, ",s?.nome||"Cliente","!"]}),e.jsx("p",{className:"text-gray-600",children:"Acompanhe o status dos seus equipamentos"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(l,{variant:"outline",size:"sm",children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"Contato"]}),e.jsxs(l,{variant:"outline",size:"sm",children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Suporte"]})]})]})})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs(b,{value:A,onValueChange:R,className:"space-y-6",children:[e.jsxs(_,{className:"grid w-full grid-cols-3",children:[e.jsxs(E,{value:"atual",children:["Serviços Atuais (",M.length,")"]}),e.jsxs(E,{value:"historico",children:["Histórico (",P.length,")"]}),e.jsx(E,{value:"perfil",children:"Meu Perfil"})]}),e.jsx(S,{value:"atual",className:"space-y-6",children:0===M.length?e.jsx(d,{children:e.jsxs(m,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(x,{className:"w-12 h-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Nenhum serviço em andamento"}),e.jsx("p",{className:"text-gray-600 text-center",children:"Você não possui equipamentos em manutenção no momento."})]})}):e.jsx("div",{className:"grid gap-6",children:M.map((a=>{const s=I[a.status];return e.jsxs(d,{className:"overflow-hidden",children:[e.jsx(h,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(u,{className:"text-lg",children:["OS #",a.numero]}),e.jsxs(p,{children:[a.equipamento?.tipo," - ",a.equipamento?.marca," ",a.equipamento?.modelo]})]}),e.jsxs(f,{className:s?.color,children:[s?.icon,e.jsx("span",{className:"ml-1",children:s?.label})]})]})}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Progresso"}),e.jsxs("span",{className:"font-medium",children:[s?.progress,"%"]})]}),e.jsx(k,{value:s?.progress,className:"h-2"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Data de Entrada:"}),e.jsx("p",{className:"font-medium",children:new Date(a.criadoEm).toLocaleDateString("pt-BR")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Técnico:"}),e.jsx("p",{className:"font-medium",children:a.tecnico?.nome||"Não atribuído"})]})]}),a.diagnostico&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Diagnóstico:"}),e.jsx("p",{className:"text-sm text-gray-700",children:a.diagnostico.descricao})]}),a.orcamento&&e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"Orçamento"}),e.jsxs("p",{className:"text-lg font-bold text-blue-600",children:["R$ ",a.orcamento.valorTotal.toFixed(2)]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(l,{size:"sm",variant:"outline",onClick:()=>D(a.orcamento.id),children:[e.jsx(j,{className:"w-4 h-4 mr-1"}),"Baixar"]}),"pendente"===a.orcamento.status&&e.jsx(l,{size:"sm",children:"Aprovar"})]})]})}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t",children:[e.jsxs(l,{variant:"outline",size:"sm",children:[e.jsx(v,{className:"w-4 h-4 mr-2"}),"Ver Detalhes"]}),e.jsxs(l,{variant:"outline",size:"sm",children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Conversar"]})]})]})]},a.id)}))})}),e.jsx(S,{value:"historico",className:"space-y-6",children:0===P.length?e.jsx(d,{children:e.jsxs(m,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(C,{className:"w-12 h-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Nenhum histórico encontrado"}),e.jsx("p",{className:"text-gray-600 text-center",children:"Você ainda não possui serviços concluídos."})]})}):e.jsx("div",{className:"grid gap-4",children:P.map((a=>e.jsx(d,{children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"font-medium",children:["OS #",a.numero]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.equipamento?.tipo," - ",a.equipamento?.marca," ",a.equipamento?.modelo]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Concluído em ",new Date(a.atualizadoEm).toLocaleDateString("pt-BR")]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[!a.avaliacao&&e.jsxs(l,{size:"sm",variant:"outline",onClick:()=>y(a.id),children:[e.jsx(q,{className:"w-4 h-4 mr-1"}),"Avaliar"]}),e.jsxs(l,{size:"sm",variant:"outline",children:[e.jsx(v,{className:"w-4 h-4 mr-1"}),"Ver"]})]})]})})},a.id)))})}),e.jsx(S,{value:"perfil",children:e.jsxs(d,{children:[e.jsxs(h,{children:[e.jsx(u,{children:"Meus Dados"}),e.jsx(p,{children:"Mantenha suas informações sempre atualizadas"})]}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Nome"}),e.jsx("p",{className:"mt-1 text-sm text-gray-900",children:s?.nome})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Email"}),e.jsx("p",{className:"mt-1 text-sm text-gray-900",children:s?.email})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Telefone"}),e.jsx("p",{className:"mt-1 text-sm text-gray-900",children:s?.telefone})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"CPF"}),e.jsx("p",{className:"mt-1 text-sm text-gray-900",children:s?.cpf})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(l,{variant:"outline",children:"Editar Informações"})})]})]})})]})})]})};export{A as default};
