import{a}from"../vendor/vendor-react.C0-ekqbG.js";import{s as e}from"../entry/index.BTJ1QXK9.js";const t=new class{async listar(a){try{let t=e.from("orcamentos").select("\n          *,\n          cliente:clientes(*),\n          equipamento:equipamentos(*),\n          itens:orcamento_itens(*)\n        ");a?.status&&(t=t.eq("status",a.status)),a?.clienteId&&(t=t.eq("cliente_id",a.clienteId)),a?.dataInicio&&(t=t.gte("criado_em",a.dataInicio.toISOString())),a?.dataFim&&(t=t.lte("criado_em",a.dataFim.toISOString()));const{data:r,error:o}=await t.order("criado_em",{ascending:!1});if(o)throw new Error(`Erro ao listar orçamentos: ${o.message}`);return this.transformarDados(r||[])}catch(t){throw t}}async buscarPorId(a){try{const{data:t,error:r}=await e.from("orcamentos").select("\n          *,\n          cliente:clientes(*),\n          equipamento:equipamentos(*),\n          itens:orcamento_itens(*)\n        ").eq("id",a).single();if(r){if("PGRST116"===r.code)return null;throw new Error(`Erro ao buscar orçamento: ${r.message}`)}return this.transformarDado(t)}catch(t){throw t}}async criar(a){try{const t=await this.gerarNumeroOrcamento(),r=a.itens.filter((a=>"peca"===a.tipo)).reduce(((a,e)=>a+e.quantidade*e.valorUnitario),0),o=a.itens.filter((a=>"servico"===a.tipo)).reduce(((a,e)=>a+e.quantidade*e.valorUnitario),0),i=r+o-a.valorDesconto,{data:n,error:s}=await e.from("orcamentos").insert({numero:t,cliente_id:a.clienteId,equipamento_id:a.equipamentoId,status:"pendente",valor_pecas:r,valor_servicos:o,valor_desconto:a.valorDesconto,valor_total:i,observacoes:a.observacoes,validade_ate:a.validadeAte}).select().single();if(s)throw new Error(`Erro ao criar orçamento: ${s.message}`);const c=a.itens.map((a=>({orcamento_id:n.id,tipo:a.tipo,peca_id:a.pecaId,descricao:a.descricao,quantidade:a.quantidade,valor_unitario:a.valorUnitario}))),{error:l}=await e.from("orcamento_itens").insert(c);if(l)throw await e.from("orcamentos").delete().eq("id",n.id),new Error(`Erro ao criar itens do orçamento: ${l.message}`);const d=await this.buscarPorId(n.id);if(!d)throw new Error("Erro ao recuperar orçamento criado");return d}catch(t){throw t}}async atualizar(a,t){try{const r={atualizado_em:(new Date).toISOString()};if(t.clienteId&&(r.cliente_id=t.clienteId),t.equipamentoId&&(r.equipamento_id=t.equipamentoId),void 0!==t.valorDesconto&&(r.valor_desconto=t.valorDesconto),void 0!==t.observacoes&&(r.observacoes=t.observacoes),t.validadeAte&&(r.validade_ate=t.validadeAte),t.itens){const o=t.itens.filter((a=>"peca"===a.tipo)).reduce(((a,e)=>a+e.quantidade*e.valorUnitario),0),i=t.itens.filter((a=>"servico"===a.tipo)).reduce(((a,e)=>a+e.quantidade*e.valorUnitario),0),n=o+i-(t.valorDesconto||0);r.valor_pecas=o,r.valor_servicos=i,r.valor_total=n,await e.from("orcamento_itens").delete().eq("orcamento_id",a);const s=t.itens.map((e=>({orcamento_id:a,tipo:e.tipo,peca_id:e.pecaId,descricao:e.descricao,quantidade:e.quantidade,valor_unitario:e.valorUnitario}))),{error:c}=await e.from("orcamento_itens").insert(s);if(c)throw new Error(`Erro ao atualizar itens: ${c.message}`)}const{error:o}=await e.from("orcamentos").update(r).eq("id",a);if(o)throw new Error(`Erro ao atualizar orçamento: ${o.message}`);const i=await this.buscarPorId(a);if(!i)throw new Error("Erro ao recuperar orçamento atualizado");return i}catch(r){throw r}}async atualizarStatus(a,t){try{const{error:r}=await e.from("orcamentos").update({status:t,atualizado_em:(new Date).toISOString()}).eq("id",a);if(r)throw new Error(`Erro ao atualizar status: ${r.message}`)}catch(r){throw r}}async excluir(a){try{await e.from("orcamento_itens").delete().eq("orcamento_id",a);const{error:t}=await e.from("orcamentos").delete().eq("id",a);if(t)throw new Error(`Erro ao excluir orçamento: ${t.message}`)}catch(t){throw t}}async reenviar(a){try{const{error:t}=await e.from("orcamentos").update({ultimo_envio:(new Date).toISOString(),atualizado_em:(new Date).toISOString()}).eq("id",a);if(t)throw new Error(`Erro ao registrar reenvio: ${t.message}`)}catch(t){throw t}}async gerarPDF(a){try{return new Blob(["PDF do orçamento"],{type:"application/pdf"})}catch(e){throw e}}async obterEstatisticas(){try{const{data:a,error:t}=await e.from("orcamentos").select("status, valor_total");if(t)throw new Error(`Erro ao obter estatísticas: ${t.message}`);return{total:a.length,pendentes:a.filter((a=>"pendente"===a.status)).length,aprovados:a.filter((a=>"aprovado"===a.status)).length,rejeitados:a.filter((a=>"rejeitado"===a.status)).length,valorTotal:a.reduce(((a,e)=>a+(e.valor_total||0)),0)}}catch(a){throw a}}async gerarNumeroOrcamento(){const a=(new Date).getFullYear(),{count:t}=await e.from("orcamentos").select("*",{count:"exact",head:!0}).gte("criado_em",`${a}-01-01`).lt("criado_em",`${a+1}-01-01`);return`ORC-${a}-${((t||0)+1).toString().padStart(3,"0")}`}transformarDados(a){return a.map((a=>this.transformarDado(a)))}transformarDado(a){return{id:a.id,numero:a.numero,clienteId:a.cliente_id,equipamentoId:a.equipamento_id,status:a.status,itens:a.itens?.map((a=>({tipo:a.tipo,pecaId:a.peca_id,descricao:a.descricao,quantidade:a.quantidade,valorUnitario:a.valor_unitario})))||[],valorPecas:a.valor_pecas,valorServicos:a.valor_servicos,valorDesconto:a.valor_desconto,valorTotal:a.valor_total,observacoes:a.observacoes,validadeAte:new Date(a.validade_ate),criadoEm:new Date(a.criado_em),atualizadoEm:new Date(a.atualizado_em),cliente:a.cliente?{id:a.cliente.id,nome:a.cliente.nome,email:a.cliente.email,telefone:a.cliente.telefone,cpf:a.cliente.cpf,criadoEm:new Date(a.cliente.criado_em),atualizadoEm:new Date(a.cliente.atualizado_em)}:void 0,equipamento:a.equipamento?{id:a.equipamento.id,clienteId:a.equipamento.cliente_id,tipo:a.equipamento.tipo,marca:a.equipamento.marca,modelo:a.equipamento.modelo,numeroSerie:a.equipamento.numero_serie,descricaoProblema:a.equipamento.descricao_problema,criadoEm:new Date(a.equipamento.criado_em),atualizadoEm:new Date(a.equipamento.atualizado_em)}:void 0}}};function r(e={}){const{autoLoad:r=!0,filtros:o}=e,[i,n]=a.useState([]),[s,c]=a.useState(!1),[l,d]=a.useState(null),[m,u]=a.useState(null),w=a.useCallback((async()=>{try{c(!0),d(null);const a=await t.listar(o);n(a)}catch(a){const e=a instanceof Error?a.message:"Erro ao carregar orçamentos";d(e)}finally{c(!1)}}),[o]),p=a.useCallback((async()=>{try{const a=await t.obterEstatisticas();u(a)}catch(a){}}),[]),v=a.useCallback((async a=>{try{d(null);const e=await t.criar(a);return n((a=>[e,...a])),await p(),e}catch(e){const a=e instanceof Error?e.message:"Erro ao criar orçamento";throw d(a),e}}),[p]),f=a.useCallback((async(a,e)=>{try{d(null);const r=await t.atualizar(a,e);return n((e=>e.map((e=>e.id===a?r:e)))),await p(),r}catch(r){const a=r instanceof Error?r.message:"Erro ao atualizar orçamento";throw d(a),r}}),[p]),_=a.useCallback((async(a,e)=>{try{d(null),await t.atualizarStatus(a,e),n((t=>t.map((t=>t.id===a?{...t,status:e,atualizadoEm:new Date}:t)))),await p()}catch(r){const a=r instanceof Error?r.message:"Erro ao atualizar status";throw d(a),r}}),[p]),h=a.useCallback((async a=>{try{d(null),await t.excluir(a),n((e=>e.filter((e=>e.id!==a)))),await p()}catch(e){const a=e instanceof Error?e.message:"Erro ao excluir orçamento";throw d(a),e}}),[p]),E=a.useCallback((async a=>{try{d(null),await t.reenviar(a),n((e=>e.map((e=>e.id===a?{...e,atualizadoEm:new Date}:e))))}catch(e){const a=e instanceof Error?e.message:"Erro ao reenviar orçamento";throw d(a),e}}),[]);return a.useEffect((()=>{r&&(w(),p())}),[r,w,p]),{orcamentos:i,loading:s,error:l,estatisticas:m,carregarOrcamentos:w,criarOrcamento:v,atualizarOrcamento:f,atualizarStatus:_,excluirOrcamento:h,reenviarOrcamento:E,carregarEstatisticas:p}}export{r as u};
